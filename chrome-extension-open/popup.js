(()=>{"use strict";var t,e,s;!function(t){t.DEEPSEEK="deepseek",t.KIMI="kimi",t.DOUBAO="doubao",t.UNKNOWN="unknown"}(t||(t={})),function(t){t.NORMAL="normal",t.LOADING="loading",t.SUCCESS="success",t.ERROR="error"}(e||(e={})),function(t){t.NETWORK_ERROR="network_error",t.API_ERROR="api_error",t.CONFIG_ERROR="config_error",t.UNKNOWN_ERROR="unknown_error"}(s||(s={})),Error;class n{constructor(){this.elements={},this.settings=null,this.currentTab=null,this.siteInfo=null,this.init()}async init(){this.bindElements(),this.bindEvents(),await this.loadSettings(),await this.getCurrentTab(),this.updateUI(),this.checkSystemStatus()}bindElements(){this.elements={settingsBtn:document.getElementById("settingsBtn"),testBtn:document.getElementById("testBtn"),configBtn:document.getElementById("configBtn"),toggleBtn:document.getElementById("toggleBtn"),statusCard:document.getElementById("statusCard"),statusIcon:document.getElementById("statusIcon"),statusTitle:document.getElementById("statusTitle"),statusDesc:document.getElementById("statusDesc"),totalUsage:document.getElementById("totalUsage"),successRate:document.getElementById("successRate"),siteName:document.getElementById("siteName"),siteStatusDot:document.getElementById("siteStatusDot"),siteStatusText:document.getElementById("siteStatusText"),toggleIcon:document.getElementById("toggleIcon"),toggleText:document.getElementById("toggleText"),feedbackLink:document.getElementById("feedbackLink")}}bindEvents(){this.elements.settingsBtn.addEventListener("click",()=>{this.openOptionsPage()}),this.elements.configBtn.addEventListener("click",()=>{this.openOptionsPage()}),this.elements.testBtn.addEventListener("click",()=>{this.testFunctionality()}),this.elements.toggleBtn.addEventListener("click",()=>{this.toggleSiteSupport()}),this.elements.feedbackLink.addEventListener("click",t=>{t.preventDefault(),this.openFeedbackForm()})}async loadSettings(){try{const t=await this.sendMessage("GET_SETTINGS");this.settings=t.success?t.data:this.getDefaultSettings()}catch(t){console.error("åŠ è½½è®¾ç½®å¤±è´¥:",t),this.settings=this.getDefaultSettings()}}getDefaultSettings(){return{llmConfig:{modelName:"",baseUrl:"",apiKey:""},knowledgeBaseConfig:{postUrl:"",datasetId:"",apiKey:""},enabledSites:[t.DEEPSEEK,t.KIMI,t.DOUBAO],enhanceButtonText:"På¢žå¼º"}}async getCurrentTab(){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});this.currentTab=t,this.siteInfo=this.analyzeSite(t.url)}catch(t){console.error("èŽ·å–å½“å‰æ ‡ç­¾é¡µå¤±è´¥:",t)}}analyzeSite(e){var s,n,i,a,o,l,c,d,r;if(!e)return{name:"æœªçŸ¥ç½‘ç«™",type:t.UNKNOWN,supported:!1,enabled:!1};const u=new URL(e).hostname;return u.includes("deepseek.com")?{name:"DeepSeek",type:t.DEEPSEEK,supported:!0,enabled:null===(i=null===(n=null===(s=this.settings)||void 0===s?void 0:s.enabledSites)||void 0===n?void 0:n.includes(t.DEEPSEEK))||void 0===i||i}:u.includes("moonshot.cn")||u.includes("kimi.com")?{name:"Kimi",type:t.KIMI,supported:!0,enabled:null===(l=null===(o=null===(a=this.settings)||void 0===a?void 0:a.enabledSites)||void 0===o?void 0:o.includes(t.KIMI))||void 0===l||l}:u.includes("doubao.com")?{name:"è±†åŒ…",type:t.DOUBAO,supported:!0,enabled:null===(r=null===(d=null===(c=this.settings)||void 0===c?void 0:c.enabledSites)||void 0===d?void 0:d.includes(t.DOUBAO))||void 0===r||r}:{name:u,type:t.UNKNOWN,supported:!1,enabled:!1}}updateUI(){this.updateSiteInfo(),this.updateStats()}updateSiteInfo(){this.siteInfo&&(this.elements.siteName.textContent=this.siteInfo.name,this.siteInfo.supported?(this.elements.siteStatusDot.className="status-dot supported",this.elements.siteStatusText.textContent="å·²æ”¯æŒ",this.siteInfo.enabled?(this.elements.toggleBtn.className="toggle-btn enabled",this.elements.toggleIcon.textContent="ðŸŸ¢",this.elements.toggleText.textContent="å·²å¯ç”¨"):(this.elements.toggleBtn.className="toggle-btn disabled",this.elements.toggleIcon.textContent="ðŸ”´",this.elements.toggleText.textContent="å·²ç¦ç”¨")):(this.elements.siteStatusDot.className="status-dot unsupported",this.elements.siteStatusText.textContent="ä¸æ”¯æŒ",this.elements.toggleBtn.style.display="none"))}updateStats(){this.elements.totalUsage.textContent="0",this.elements.successRate.textContent="0%"}async checkSystemStatus(){this.setStatusChecking();try{const t=this.checkConfiguration();if("error"===t.level)return void this.setStatusError(t.title,t.desc);if("warning"===t.level)return void this.setStatusWarning(t.title,t.desc);await this.checkConnections()}catch(t){this.setStatusError("ç³»ç»Ÿå¼‚å¸¸",t.message)}}checkConfiguration(){if(!this.settings)return{level:"error",title:"é…ç½®ç¼ºå¤±",desc:"è¯·å…ˆé…ç½®å¤§æ¨¡åž‹å’ŒçŸ¥è¯†åº“"};const{llmConfig:t,knowledgeBaseConfig:e}=this.settings,s=t.modelName&&t.baseUrl&&t.apiKey,n=e.postUrl&&e.datasetId&&e.apiKey;return s||n?s?n?{level:"success",title:"é…ç½®å®Œæ•´",desc:"æ‰€æœ‰é…ç½®é¡¹å·²å®Œæˆ"}:{level:"warning",title:"çŸ¥è¯†åº“æœªé…ç½®",desc:"å»ºè®®é…ç½®çŸ¥è¯†åº“ä»¥èŽ·å¾—æ›´å¥½çš„å¢žå¼ºæ•ˆæžœ"}:{level:"warning",title:"å¤§æ¨¡åž‹æœªé…ç½®",desc:"éœ€è¦é…ç½®å¤§æ¨¡åž‹APIæ‰èƒ½ä½¿ç”¨å¢žå¼ºåŠŸèƒ½"}:{level:"error",title:"é…ç½®ç¼ºå¤±",desc:"è¯·å…ˆé…ç½®å¤§æ¨¡åž‹å’ŒçŸ¥è¯†åº“"}}async checkConnections(){try{const t=await this.sendMessage("TEST_LLM_CONNECTION");if(!t.success)return void this.setStatusWarning("å¤§æ¨¡åž‹è¿žæŽ¥å¼‚å¸¸",t.error||"è¿žæŽ¥æµ‹è¯•å¤±è´¥");const e=await this.sendMessage("TEST_KB_CONNECTION");if(!e.success)return void this.setStatusWarning("çŸ¥è¯†åº“è¿žæŽ¥å¼‚å¸¸",e.error||"è¿žæŽ¥æµ‹è¯•å¤±è´¥");this.setStatusReady()}catch(t){this.setStatusError("è¿žæŽ¥æµ‹è¯•å¤±è´¥",t.message)}}setStatusChecking(){this.elements.statusCard.className="status-card",this.elements.statusIcon.textContent="ðŸ”„",this.elements.statusIcon.className="status-icon checking",this.elements.statusTitle.textContent="æ£€æŸ¥ä¸­...",this.elements.statusDesc.textContent="æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"}setStatusReady(){this.elements.statusCard.className="status-card ready",this.elements.statusIcon.textContent="âœ…",this.elements.statusIcon.className="status-icon",this.elements.statusTitle.textContent="å°±ç»ª",this.elements.statusDesc.textContent="ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨",this.elements.testBtn.disabled=!1}setStatusWarning(t,e){this.elements.statusCard.className="status-card warning",this.elements.statusIcon.textContent="âš ï¸",this.elements.statusIcon.className="status-icon",this.elements.statusTitle.textContent=t,this.elements.statusDesc.textContent=e,this.elements.testBtn.disabled=!1}setStatusError(t,e){this.elements.statusCard.className="status-card error",this.elements.statusIcon.textContent="âŒ",this.elements.statusIcon.className="status-icon",this.elements.statusTitle.textContent=t,this.elements.statusDesc.textContent=e,this.elements.testBtn.disabled=!0}async testFunctionality(){var t,e;if(null===(t=this.siteInfo)||void 0===t?void 0:t.supported){this.setButtonLoading(this.elements.testBtn,!0);try{if(!(null===(e=this.currentTab)||void 0===e?void 0:e.id))throw new Error("å½“å‰æ ‡ç­¾é¡µä¸å¯ç”¨");await chrome.tabs.sendMessage(this.currentTab.id,{type:"TEST_ENHANCEMENT",data:{test:!0}}),this.showTemporaryStatus("âœ…","æµ‹è¯•å®Œæˆ","åŠŸèƒ½æµ‹è¯•æˆåŠŸï¼Œè¯·æŸ¥çœ‹é¡µé¢ä¸Šçš„På¢žå¼ºæŒ‰é’®")}catch(t){this.showTemporaryStatus("âŒ","æµ‹è¯•å¤±è´¥",t.message||"æ— æ³•ä¸Žé¡µé¢é€šä¿¡ï¼Œè¯·åˆ·æ–°é¡µé¢åŽé‡è¯•")}finally{this.setButtonLoading(this.elements.testBtn,!1)}}else alert("å½“å‰ç½‘ç«™ä¸æ”¯æŒæç¤ºè¯å¢žå¼ºåŠŸèƒ½")}async toggleSiteSupport(){var t,e;if(!(null===(t=this.siteInfo)||void 0===t?void 0:t.supported))return;if(!this.settings)return;const s=!this.siteInfo.enabled,n=[...this.settings.enabledSites];if(s)n.includes(this.siteInfo.type)||n.push(this.siteInfo.type);else{const t=n.indexOf(this.siteInfo.type);t>-1&&n.splice(t,1)}const i={...this.settings,enabledSites:n};try{(await this.sendMessage("UPDATE_SETTINGS",i)).success&&(this.settings=i,this.siteInfo.enabled=s,this.updateSiteInfo(),(null===(e=this.currentTab)||void 0===e?void 0:e.id)&&chrome.tabs.sendMessage(this.currentTab.id,{type:"SITE_STATUS_CHANGED",data:{enabled:s}}).catch(()=>{}))}catch(t){console.error("æ›´æ–°è®¾ç½®å¤±è´¥:",t)}}openOptionsPage(){chrome.runtime.openOptionsPage(),window.close()}openFeedbackForm(){chrome.tabs.create({url:"https://github.com/comeonzhj/batter-prompts-plugins/issues/new"}),window.close()}showTemporaryStatus(t,e,s,n=3e3){const i=this.elements.statusCard.className,a=this.elements.statusIcon.textContent,o=this.elements.statusTitle.textContent,l=this.elements.statusDesc.textContent;this.elements.statusCard.className="status-card",this.elements.statusIcon.textContent=t,this.elements.statusTitle.textContent=e,this.elements.statusDesc.textContent=s,setTimeout(()=>{this.elements.statusCard.className=i,this.elements.statusIcon.textContent=a,this.elements.statusTitle.textContent=o,this.elements.statusDesc.textContent=l},n)}setButtonLoading(t,e){e?(t.classList.add("loading"),t.disabled=!0):(t.classList.remove("loading"),t.disabled=!1)}sendMessage(t,e){return new Promise(s=>{chrome.runtime.sendMessage({type:t,data:e},t=>{chrome.runtime.lastError?s({success:!1,error:chrome.runtime.lastError.message}):s(t||{success:!1,error:"æ— å“åº”"})})})}}document.addEventListener("DOMContentLoaded",()=>{new n}),window.popupManager=null,document.addEventListener("DOMContentLoaded",()=>{window.popupManager=new n})})();
