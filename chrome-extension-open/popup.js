(()=>{"use strict";var t,e,s;!function(t){t.DEEPSEEK="deepseek",t.KIMI="kimi",t.DOUBAO="doubao",t.UNKNOWN="unknown"}(t||(t={})),function(t){t.NORMAL="normal",t.LOADING="loading",t.SUCCESS="success",t.ERROR="error"}(e||(e={})),function(t){t.NETWORK_ERROR="network_error",t.API_ERROR="api_error",t.CONFIG_ERROR="config_error",t.UNKNOWN_ERROR="unknown_error"}(s||(s={})),Error;class n{constructor(){this.elements={},this.settings=null,this.currentTab=null,this.siteInfo=null,this.init()}async init(){this.bindElements(),this.bindEvents(),await this.loadSettings(),await this.getCurrentTab(),this.updateUI(),this.checkSystemStatus()}bindElements(){this.elements={settingsBtn:document.getElementById("settingsBtn"),testBtn:document.getElementById("testBtn"),configBtn:document.getElementById("configBtn"),toggleBtn:document.getElementById("toggleBtn"),statusCard:document.getElementById("statusCard"),statusIcon:document.getElementById("statusIcon"),statusTitle:document.getElementById("statusTitle"),statusDesc:document.getElementById("statusDesc"),totalUsage:document.getElementById("totalUsage"),successRate:document.getElementById("successRate"),siteName:document.getElementById("siteName"),siteStatusDot:document.getElementById("siteStatusDot"),siteStatusText:document.getElementById("siteStatusText"),toggleIcon:document.getElementById("toggleIcon"),toggleText:document.getElementById("toggleText"),feedbackLink:document.getElementById("feedbackLink")}}bindEvents(){this.elements.settingsBtn.addEventListener("click",()=>{this.openOptionsPage()}),this.elements.configBtn.addEventListener("click",()=>{this.openOptionsPage()}),this.elements.testBtn.addEventListener("click",()=>{this.testFunctionality()}),this.elements.toggleBtn.addEventListener("click",()=>{this.toggleSiteSupport()}),this.elements.feedbackLink.addEventListener("click",t=>{t.preventDefault(),this.openFeedbackForm()})}async loadSettings(){try{const t=await this.sendMessage("GET_SETTINGS");this.settings=t.success?t.data:this.getDefaultSettings()}catch(t){console.error("加载设置失败:",t),this.settings=this.getDefaultSettings()}}getDefaultSettings(){return{llmConfig:{modelName:"",baseUrl:"",apiKey:""},knowledgeBaseConfig:{postUrl:"",datasetId:"",apiKey:""},enabledSites:[t.DEEPSEEK,t.KIMI,t.DOUBAO],enhanceButtonText:"P增强"}}async getCurrentTab(){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});this.currentTab=t,this.siteInfo=this.analyzeSite(t.url)}catch(t){console.error("获取当前标签页失败:",t)}}analyzeSite(e){var s,n,i,a,o,l,c,d,r;if(!e)return{name:"未知网站",type:t.UNKNOWN,supported:!1,enabled:!1};const u=new URL(e).hostname;return u.includes("deepseek.com")?{name:"DeepSeek",type:t.DEEPSEEK,supported:!0,enabled:null===(i=null===(n=null===(s=this.settings)||void 0===s?void 0:s.enabledSites)||void 0===n?void 0:n.includes(t.DEEPSEEK))||void 0===i||i}:u.includes("moonshot.cn")||u.includes("kimi.com")?{name:"Kimi",type:t.KIMI,supported:!0,enabled:null===(l=null===(o=null===(a=this.settings)||void 0===a?void 0:a.enabledSites)||void 0===o?void 0:o.includes(t.KIMI))||void 0===l||l}:u.includes("doubao.com")?{name:"豆包",type:t.DOUBAO,supported:!0,enabled:null===(r=null===(d=null===(c=this.settings)||void 0===c?void 0:c.enabledSites)||void 0===d?void 0:d.includes(t.DOUBAO))||void 0===r||r}:{name:u,type:t.UNKNOWN,supported:!1,enabled:!1}}updateUI(){this.updateSiteInfo(),this.updateStats()}updateSiteInfo(){this.siteInfo&&(this.elements.siteName.textContent=this.siteInfo.name,this.siteInfo.supported?(this.elements.siteStatusDot.className="status-dot supported",this.elements.siteStatusText.textContent="已支持",this.siteInfo.enabled?(this.elements.toggleBtn.className="toggle-btn enabled",this.elements.toggleIcon.textContent="🟢",this.elements.toggleText.textContent="已启用"):(this.elements.toggleBtn.className="toggle-btn disabled",this.elements.toggleIcon.textContent="🔴",this.elements.toggleText.textContent="已禁用")):(this.elements.siteStatusDot.className="status-dot unsupported",this.elements.siteStatusText.textContent="不支持",this.elements.toggleBtn.style.display="none"))}updateStats(){this.elements.totalUsage.textContent="0",this.elements.successRate.textContent="0%"}async checkSystemStatus(){this.setStatusChecking();try{const t=this.checkConfiguration();if("error"===t.level)return void this.setStatusError(t.title,t.desc);if("warning"===t.level)return void this.setStatusWarning(t.title,t.desc);await this.checkConnections()}catch(t){this.setStatusError("系统异常",t.message)}}checkConfiguration(){if(!this.settings)return{level:"error",title:"配置缺失",desc:"请先配置大模型和知识库"};const{llmConfig:t,knowledgeBaseConfig:e}=this.settings,s=t.modelName&&t.baseUrl&&t.apiKey,n=e.postUrl&&e.datasetId&&e.apiKey;return s||n?s?n?{level:"success",title:"配置完整",desc:"所有配置项已完成"}:{level:"warning",title:"知识库未配置",desc:"建议配置知识库以获得更好的增强效果"}:{level:"warning",title:"大模型未配置",desc:"需要配置大模型API才能使用增强功能"}:{level:"error",title:"配置缺失",desc:"请先配置大模型和知识库"}}async checkConnections(){try{const t=await this.sendMessage("TEST_LLM_CONNECTION");if(!t.success)return void this.setStatusWarning("大模型连接异常",t.error||"连接测试失败");const e=await this.sendMessage("TEST_KB_CONNECTION");if(!e.success)return void this.setStatusWarning("知识库连接异常",e.error||"连接测试失败");this.setStatusReady()}catch(t){this.setStatusError("连接测试失败",t.message)}}setStatusChecking(){this.elements.statusCard.className="status-card",this.elements.statusIcon.textContent="🔄",this.elements.statusIcon.className="status-icon checking",this.elements.statusTitle.textContent="检查中...",this.elements.statusDesc.textContent="正在检查系统状态"}setStatusReady(){this.elements.statusCard.className="status-card ready",this.elements.statusIcon.textContent="✅",this.elements.statusIcon.className="status-icon",this.elements.statusTitle.textContent="就绪",this.elements.statusDesc.textContent="系统运行正常，可以正常使用",this.elements.testBtn.disabled=!1}setStatusWarning(t,e){this.elements.statusCard.className="status-card warning",this.elements.statusIcon.textContent="⚠️",this.elements.statusIcon.className="status-icon",this.elements.statusTitle.textContent=t,this.elements.statusDesc.textContent=e,this.elements.testBtn.disabled=!1}setStatusError(t,e){this.elements.statusCard.className="status-card error",this.elements.statusIcon.textContent="❌",this.elements.statusIcon.className="status-icon",this.elements.statusTitle.textContent=t,this.elements.statusDesc.textContent=e,this.elements.testBtn.disabled=!0}async testFunctionality(){var t,e;if(null===(t=this.siteInfo)||void 0===t?void 0:t.supported){this.setButtonLoading(this.elements.testBtn,!0);try{if(!(null===(e=this.currentTab)||void 0===e?void 0:e.id))throw new Error("当前标签页不可用");await chrome.tabs.sendMessage(this.currentTab.id,{type:"TEST_ENHANCEMENT",data:{test:!0}}),this.showTemporaryStatus("✅","测试完成","功能测试成功，请查看页面上的P增强按钮")}catch(t){this.showTemporaryStatus("❌","测试失败",t.message||"无法与页面通信，请刷新页面后重试")}finally{this.setButtonLoading(this.elements.testBtn,!1)}}else alert("当前网站不支持提示词增强功能")}async toggleSiteSupport(){var t,e;if(!(null===(t=this.siteInfo)||void 0===t?void 0:t.supported))return;if(!this.settings)return;const s=!this.siteInfo.enabled,n=[...this.settings.enabledSites];if(s)n.includes(this.siteInfo.type)||n.push(this.siteInfo.type);else{const t=n.indexOf(this.siteInfo.type);t>-1&&n.splice(t,1)}const i={...this.settings,enabledSites:n};try{(await this.sendMessage("UPDATE_SETTINGS",i)).success&&(this.settings=i,this.siteInfo.enabled=s,this.updateSiteInfo(),(null===(e=this.currentTab)||void 0===e?void 0:e.id)&&chrome.tabs.sendMessage(this.currentTab.id,{type:"SITE_STATUS_CHANGED",data:{enabled:s}}).catch(()=>{}))}catch(t){console.error("更新设置失败:",t)}}openOptionsPage(){chrome.runtime.openOptionsPage(),window.close()}openFeedbackForm(){chrome.tabs.create({url:"https://github.com/comeonzhj/batter-prompts-plugins/issues/new"}),window.close()}showTemporaryStatus(t,e,s,n=3e3){const i=this.elements.statusCard.className,a=this.elements.statusIcon.textContent,o=this.elements.statusTitle.textContent,l=this.elements.statusDesc.textContent;this.elements.statusCard.className="status-card",this.elements.statusIcon.textContent=t,this.elements.statusTitle.textContent=e,this.elements.statusDesc.textContent=s,setTimeout(()=>{this.elements.statusCard.className=i,this.elements.statusIcon.textContent=a,this.elements.statusTitle.textContent=o,this.elements.statusDesc.textContent=l},n)}setButtonLoading(t,e){e?(t.classList.add("loading"),t.disabled=!0):(t.classList.remove("loading"),t.disabled=!1)}sendMessage(t,e){return new Promise(s=>{chrome.runtime.sendMessage({type:t,data:e},t=>{chrome.runtime.lastError?s({success:!1,error:chrome.runtime.lastError.message}):s(t||{success:!1,error:"无响应"})})})}}document.addEventListener("DOMContentLoaded",()=>{new n}),window.popupManager=null,document.addEventListener("DOMContentLoaded",()=>{window.popupManager=new n})})();
