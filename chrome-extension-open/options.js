(()=>{"use strict";var e,t,s;!function(e){e.DEEPSEEK="deepseek",e.KIMI="kimi",e.DOUBAO="doubao",e.UNKNOWN="unknown"}(e||(e={})),function(e){e.NORMAL="normal",e.LOADING="loading",e.SUCCESS="success",e.ERROR="error"}(t||(t={})),function(e){e.NETWORK_ERROR="network_error",e.API_ERROR="api_error",e.CONFIG_ERROR="config_error",e.UNKNOWN_ERROR="unknown_error"}(s||(s={})),Error;class n{constructor(){this.elements={},this.settings=null,this.init()}async init(){this.bindElements(),this.bindEvents(),await this.loadSettings(),this.updateUI(),this.updateStatus()}bindElements(){this.elements={modelName:document.getElementById("modelName"),baseUrl:document.getElementById("baseUrl"),apiKey:document.getElementById("apiKey"),testLLMBtn:document.getElementById("testLLMBtn"),postUrl:document.getElementById("postUrl"),datasetId:document.getElementById("datasetId"),kbApiKey:document.getElementById("kbApiKey"),testKBBtn:document.getElementById("testKBBtn"),buttonText:document.getElementById("buttonText"),enableDeepSeek:document.getElementById("enableDeepSeek"),enableKimi:document.getElementById("enableKimi"),enableDoubao:document.getElementById("enableDoubao"),saveBtn:document.getElementById("saveBtn"),resetBtn:document.getElementById("resetBtn"),llmStatus:document.getElementById("llmStatus"),kbStatus:document.getElementById("kbStatus"),toastContainer:document.getElementById("toastContainer")}}bindEvents(){this.elements.testLLMBtn.addEventListener("click",()=>this.testLLMConnection()),this.elements.testKBBtn.addEventListener("click",()=>this.testKBConnection()),this.elements.saveBtn.addEventListener("click",()=>this.saveSettings()),this.elements.resetBtn.addEventListener("click",()=>this.resetSettings()),[this.elements.modelName,this.elements.baseUrl,this.elements.apiKey,this.elements.postUrl,this.elements.datasetId,this.elements.kbApiKey,this.elements.buttonText].forEach(e=>{e.addEventListener("input",()=>this.onInputChange())}),[this.elements.enableDeepSeek,this.elements.enableKimi,this.elements.enableDoubao].forEach(e=>{e.addEventListener("change",()=>this.onInputChange())})}async loadSettings(){try{const e=await chrome.storage.sync.get(["settings"]);this.settings=e.settings||this.getDefaultSettings()}catch(e){console.error("加载设置失败:",e),this.settings=this.getDefaultSettings(),this.showToast("加载设置失败，使用默认配置","error")}}getDefaultSettings(){return{llmConfig:{modelName:"",baseUrl:"",apiKey:""},knowledgeBaseConfig:{postUrl:"",datasetId:"",apiKey:""},enabledSites:[e.DEEPSEEK,e.KIMI,e.DOUBAO],enhanceButtonText:"P增强"}}updateUI(){if(!this.settings)return;this.elements.modelName.value=this.settings.llmConfig.modelName||"",this.elements.baseUrl.value=this.settings.llmConfig.baseUrl||"",this.elements.apiKey.value=this.settings.llmConfig.apiKey||"",this.elements.postUrl.value=this.settings.knowledgeBaseConfig.postUrl||"",this.elements.datasetId.value=this.settings.knowledgeBaseConfig.datasetId||"",this.elements.kbApiKey.value=this.settings.knowledgeBaseConfig.apiKey||"",this.elements.buttonText.value=this.settings.enhanceButtonText||"P增强";const t=this.settings.enabledSites||[];this.elements.enableDeepSeek.checked=t.includes(e.DEEPSEEK),this.elements.enableKimi.checked=t.includes(e.KIMI),this.elements.enableDoubao.checked=t.includes(e.DOUBAO)}updateStatus(){const e=this.isLLMConfigured();this.updateStatusIndicator(this.elements.llmStatus,e);const t=this.isKBConfigured();this.updateStatusIndicator(this.elements.kbStatus,t)}updateStatusIndicator(e,t){e.className="status-indicator",!0===t?(e.classList.add("connected"),e.textContent="已配置"):!1===t?(e.classList.add("disconnected"),e.textContent="配置错误"):(e.classList.add("unconfigured"),e.textContent="未配置")}isLLMConfigured(){const e=this.getCurrentLLMConfig();return!!(e.modelName&&e.baseUrl&&e.apiKey)||null}isKBConfigured(){const e=this.getCurrentKBConfig();return!!(e.postUrl&&e.datasetId&&e.apiKey)||null}getCurrentLLMConfig(){return{modelName:this.elements.modelName.value.trim(),baseUrl:this.elements.baseUrl.value.trim(),apiKey:this.elements.apiKey.value.trim()}}getCurrentKBConfig(){return{postUrl:this.elements.postUrl.value.trim(),datasetId:this.elements.datasetId.value.trim(),apiKey:this.elements.kbApiKey.value.trim()}}async testLLMConnection(){const e=this.getCurrentLLMConfig();if(e.modelName&&e.baseUrl&&e.apiKey){this.setButtonLoading(this.elements.testLLMBtn,!0);try{const t=await this.sendMessage("TEST_LLM_CONNECTION",e);if(!t.success)throw new Error(t.error||"连接测试失败");this.showToast("大模型连接测试成功！","success"),this.updateStatusIndicator(this.elements.llmStatus,!0)}catch(e){this.showToast(`大模型连接测试失败: ${e.message}`,"error"),this.updateStatusIndicator(this.elements.llmStatus,!1)}finally{this.setButtonLoading(this.elements.testLLMBtn,!1)}}else this.showToast("请先填写完整的大模型配置信息","warning")}async testKBConnection(){const e=this.getCurrentKBConfig();if(e.postUrl&&e.datasetId&&e.apiKey){this.setButtonLoading(this.elements.testKBBtn,!0);try{const t=await this.sendMessage("TEST_KB_CONNECTION",e);if(!t.success)throw new Error(t.error||"连接测试失败");this.showToast("知识库连接测试成功！","success"),this.updateStatusIndicator(this.elements.kbStatus,!0)}catch(e){this.showToast(`知识库连接测试失败: ${e.message}`,"error"),this.updateStatusIndicator(this.elements.kbStatus,!1)}finally{this.setButtonLoading(this.elements.testKBBtn,!1)}}else this.showToast("请先填写完整的知识库配置信息","warning")}async saveSettings(){this.setButtonLoading(this.elements.saveBtn,!0);try{const e={llmConfig:this.getCurrentLLMConfig(),knowledgeBaseConfig:this.getCurrentKBConfig(),enabledSites:this.getEnabledSites(),enhanceButtonText:this.elements.buttonText.value.trim()||"P增强"},t=await this.sendMessage("UPDATE_SETTINGS",e);if(!t.success)throw new Error(t.error||"保存失败");this.settings=e,this.showToast("配置已保存！","success"),this.updateStatus()}catch(e){this.showToast(`保存配置失败: ${e.message}`,"error")}finally{this.setButtonLoading(this.elements.saveBtn,!1)}}getEnabledSites(){const t=[];return this.elements.enableDeepSeek.checked&&t.push(e.DEEPSEEK),this.elements.enableKimi.checked&&t.push(e.KIMI),this.elements.enableDoubao.checked&&t.push(e.DOUBAO),t}async resetSettings(){if(confirm("确定要重置为默认配置吗？这将清除所有当前设置。")){this.setButtonLoading(this.elements.resetBtn,!0);try{const e=this.getDefaultSettings(),t=await this.sendMessage("UPDATE_SETTINGS",e);if(!t.success)throw new Error(t.error||"重置失败");this.settings=e,this.updateUI(),this.updateStatus(),this.showToast("已重置为默认配置","info")}catch(e){this.showToast(`重置配置失败: ${e.message}`,"error")}finally{this.setButtonLoading(this.elements.resetBtn,!1)}}}onInputChange(){setTimeout(()=>{this.updateStatus()},100)}setButtonLoading(e,t){t?(e.classList.add("loading"),e.disabled=!0):(e.classList.remove("loading"),e.disabled=!1)}sendMessage(e,t){return new Promise(s=>{chrome.runtime.sendMessage({type:e,data:t},e=>{chrome.runtime.lastError?s({success:!1,error:chrome.runtime.lastError.message}):s(e||{success:!1,error:"无响应"})})})}showToast(e,t="info",s=3e3){const n=document.createElement("div");n.className=`toast ${t}`,n.textContent=e,this.elements.toastContainer.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>{n.parentElement&&n.remove()},300)},s)}}const i=document.createElement("style");i.textContent="\n  @keyframes slideOut {\n    from {\n      transform: translateX(0);\n      opacity: 1;\n    }\n    to {\n      transform: translateX(100%);\n      opacity: 0;\n    }\n  }\n",document.head.appendChild(i),document.addEventListener("DOMContentLoaded",()=>{new n}),window.optionsPage=null,document.addEventListener("DOMContentLoaded",()=>{window.optionsPage=new n})})();